---
name: go-zero 保护机制配置和业务级限流实现
status: open
created: 2025-09-15T03:33:56Z
updated: 2025-09-15T03:51:59Z
github: [Will be updated when synced to GitHub]
depends_on: [005, 006, 007]
parallel: true
conflicts_with: []
---

# Task: go-zero 保护机制配置和业务级限流实现

## Description
配置和优化 go-zero 框架内置的限流熔断保护机制，并在此基础上实现业务级别的限流策略。充分利用 go-zero 经过验证的算法，重点实现业务系统级配额控制、API Key 级限流和可观测性增强。

## Acceptance Criteria
- [ ] 配置 go-zero 内置限流器 (令牌桶算法)
- [ ] 配置 go-zero 内置熔断器 (自适应熔断)
- [ ] 实现业务系统级配额限流
- [ ] 实现 API Key 级别限流控制
- [ ] 增强限流熔断监控和可观测性
- [ ] 实现动态限流规则配置
- [ ] 限流降级策略和响应处理

## Technical Details
### go-zero 内置保护机制配置
1. **限流器配置**
   ```yaml
   # etc/config.yaml
   Name: task-center-api
   Host: 0.0.0.0
   Port: 8888
   # go-zero 内置限流配置
   RateLimiter:
     Rate: 1000     # 每秒允许的请求数
     Burst: 2000    # 突发请求数
   ```

2. **熔断器配置**
   ```yaml
   # 超时和熔断配置
   Timeout: 30s           # 请求超时时间
   # go-zero 会自动启用自适应熔断器
   ```

### 业务级限流实现
1. **业务系统配额限流**
   - 基于 business_systems 表的 rate_limit 字段
   - 每个业务系统独立的请求配额
   - 按时间窗口重置配额 (每分钟/小时)

2. **API Key 级别限流**
   - 基于 API Key 的请求频率控制
   - 支持不同 API Key 的差异化限流
   - 异常 API Key 的快速封禁

3. **接口级别限流**
   - 任务创建接口限流 (防止恶意创建)
   - 查询接口限流 (防止频繁查询)
   - 批量操作接口限流

### 限流策略实现
- **滑动窗口计数器**: 精确的请求频率控制
- **Redis 分布式限流**: 支持多实例部署
- **内存+Redis 双层限流**: 性能优化

### 降级和响应处理
- **限流降级策略**: 返回 429 状态码和 Retry-After 头
- **熔断降级策略**: 返回缓存数据或默认响应
- **优雅降级**: 保护核心功能，暂停非关键服务

### 监控增强
- **限流指标**: 限流触发次数、被限流的业务系统
- **熔断指标**: 熔断触发次数、恢复时间
- **配额使用率**: 各业务系统的配额使用情况
- **Prometheus 指标**: 集成到监控系统

### 动态配置
- **配置热更新**: 支持运行时调整限流参数
- **业务系统配额调整**: 支持动态修改业务系统配额
- **紧急限流**: 支持紧急情况下的全局限流

## Dependencies
- [ ] Task 005 - 认证授权系统完成
- [ ] Task 006 - 任务调度引擎完成
- [ ] Task 007 - 回调执行系统完成
- [ ] Redis 实例 (用于分布式限流)
- [ ] go-zero v1.5+ 框架

## Effort Estimate
- Size: S
- Hours: 16 小时 (减少 8 小时，因为使用 go-zero 内置机制)
- Parallel: true (可与其他企业级特性并行)

## Definition of Done
- [ ] go-zero 内置限流熔断配置完成
- [ ] 业务系统级配额限流实现
- [ ] API Key 级别限流功能正常
- [ ] 限流降级策略生效
- [ ] 监控指标集成完成
- [ ] 动态配置功能可用
- [ ] 压力测试验证通过 (验证限流阈值)
- [ ] 故障注入测试通过 (验证熔断恢复)